// Code generated by github.com/hasura/ndc-sdk-go/cmd/hasura-ndc-go, DO NOT EDIT.
package functions
import (
  "context"
	"github.com/hasura/ndc-codegen-example/types"
  "github.com/hasura/ndc-codegen-subdir-test/connector/types"
  "github.com/hasura/ndc-sdk-go/connector"
  "github.com/hasura/ndc-sdk-go/schema"
  "github.com/hasura/ndc-sdk-go/utils"
  "go.opentelemetry.io/otel/trace"
  "log/slog"
  "slices"
)

// FromValue decodes values from map
func (j *GetArticlesArguments) FromValue(input map[string]any) error {
  var err error
  j.Author, err = utils.DecodeObject[types.Author](input)
  if err != nil {
    return err
  }
  j.Limit, err = utils.GetFloat[float64](input, "Limit")
  if err != nil {
    return err
  }
  return nil
}
// ToMap encodes the struct to a value map
func (j GetArticlesResult) ToMap() map[string]any {
  r := make(map[string]any)
  r = utils.MergeMap(r, j.Author.ToMap())
  r["id"] = j.ID

  return r
}
// DataConnectorHandler implements the data connector handler 
type DataConnectorHandler struct{}

// QueryExists check if the query name exists
func (dch DataConnectorHandler) QueryExists(name string) bool {
  return slices.Contains(enumValues_FunctionName, name)
}
func (dch DataConnectorHandler) Query(ctx context.Context, state *types.State, request *schema.QueryRequest, rawArgs map[string]any) (*schema.RowSet, error) {
  if !dch.QueryExists(request.Collection) {
    return nil, utils.ErrHandlerNotfound
  }
  queryFields, err := utils.EvalFunctionSelectionFieldValue(request)
  if err != nil {
    return nil, schema.UnprocessableContentError(err.Error(), nil)
  }

  result, err := dch.execQuery(ctx, state, request, queryFields, rawArgs)
  if err != nil {
    return nil, err
  }
  
  return &schema.RowSet{
    Aggregates: schema.RowSetAggregates{},
    Rows: []map[string]any{
      {
        "__value": result,
      },
    },
  }, nil
}
  
func (dch DataConnectorHandler) execQuery(ctx context.Context, state *types.State, request *schema.QueryRequest, queryFields schema.NestedField, rawArgs map[string]any) (any, error) {
  span := trace.SpanFromContext(ctx)
  logger := connector.GetLogger(ctx)
  switch request.Collection {
  case "getArticles":

    selection, err := queryFields.AsArray()
    if err != nil {
      return nil, schema.UnprocessableContentError("the selection field type must be array", map[string]any{
        "cause": err.Error(),
      })
    }
			var args GetArticlesArguments
    parseErr := args.FromValue(rawArgs)
		if parseErr != nil {
      return nil, schema.UnprocessableContentError("failed to resolve arguments", map[string]any{
        "cause": parseErr.Error(),
      })
    }
    
    connector_addSpanEvent(span, logger, "execute_function", map[string]any{
      "arguments": args,
    })
    rawResult, err := GetArticles(ctx, state, &args)

    if err != nil {
      return nil, err
    }

    connector_addSpanEvent(span, logger, "evaluate_response_selection", map[string]any{
      "raw_result": rawResult,
    })
    result, err := utils.EvalNestedColumnArrayIntoSlice(selection, rawResult)
    if err != nil {
      return nil, err
    }
    return result, nil

  default:
    return nil, utils.ErrHandlerNotfound
  }
}
var enumValues_FunctionName = []string{"getArticles"}    
func connector_addSpanEvent(span trace.Span, logger *slog.Logger, name string, data map[string]any, options ...trace.EventOption) {
  logger.Debug(name, slog.Any("data", data))
  attrs := utils.DebugJSONAttributes(data, utils.IsDebug(logger))
  span.AddEvent(name, append(options, trace.WithAttributes(attrs...))...)
}